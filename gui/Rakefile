require 'rake/clean'
require 'pathname'

MODULE_TO_FILENAME = {}

$modules_dir = Pathname('lib/modules')

# Each file instantiates a module, which adds itself to MODULE_TO_FILENAME
FileList.new($modules_dir / '*.rb')
    .each {|file| require_relative file}

$modules = MODULE_TO_FILENAME.keys

$local_svg_dir = Pathname('_svg')
directory $local_svg_dir

$faceplate_file_to_module = Hash[$modules.map {|m| [m.faceplate_file, m]}]
$faceplate_files = $faceplate_file_to_module.keys
$faceplate_paths = $faceplate_files.map{ |f| $local_svg_dir / f.path }

$faceplate_files.each do |faceplate_file|
  m = $faceplate_file_to_module[faceplate_file]
  module_path = MODULE_TO_FILENAME[m]
  faceplate_path = $local_svg_dir / faceplate_file.path

  file faceplate_path => [$local_svg_dir, module_path] do
    puts faceplate_path
    faceplate_file.write($local_svg_dir)
  end
end

$local_image_dir = Pathname('_images')
directory $local_image_dir

$image_file_to_module = Hash[$modules.map {|m| [m.image_file, m]}]
$image_files = $image_file_to_module.keys
$image_paths = $image_files.map{ |f| $local_image_dir / f.path }

$image_files.each do |image_file|
  m = $image_file_to_module[image_file]
  module_path = MODULE_TO_FILENAME[m]
  image_path = $local_image_dir / image_file.path

  file image_path => [$local_image_dir, module_path] do
    puts image_path
    image_file.write($local_image_dir)
  end
end

$controls = $modules.flat_map(&:controls)
$control_to_module = Hash[$controls.collect {|c| [c, c.faceplate]}]
$control_file_to_control = Hash[
    $controls
        .flat_map {|control| control.svg_files.map {|svg_file| [svg_file, control]}}
        .uniq {|pair| pair.first.path}
]
$control_files = $control_file_to_control.keys
$control_paths = $control_files.map{ |f| $local_svg_dir / f.path }

$control_files.each do |control_file|
  control = $control_file_to_control[control_file]
  m = $control_to_module[control]
  module_path = MODULE_TO_FILENAME[m]
  control_path = $local_svg_dir / control_file.path

  file control_path => [$local_svg_dir, module_path] do
    puts control_path
    control_file.write($local_svg_dir)
  end
end

task default: $control_paths + $faceplate_paths + $image_paths

task fresh: [:clobber, :default]

CLEAN.include $local_image_dir, $local_svg_dir
