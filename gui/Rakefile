class Float
  def to_s
    '%.3f' % self
  end
end

require 'rake/clean'
require 'pathname'
require_relative 'lib/module_factory'
require_relative 'lib/svg_file'

def inkscape(from:, to:)
  from = from.expand_path.to_s
  to = to.expand_path.to_s
  sh '/Applications/Inkscape.app/Contents/Resources/script', '--export-text-to-path', "--export-plain-svg=#{to}", from
end

modules_dir = Pathname('modules')
svg_build_dir = Pathname('_svg')
svg_install_dir = Pathname('../svg')
image_build_dir = Pathname('_images')
image_install_dir = Pathname('../images')

directory svg_build_dir
directory svg_install_dir
directory image_build_dir
directory image_install_dir

modules = FileList.new(modules_dir / '*.rb').map {|file| ModuleFactory.new(file).build}

modules.each do |mod|
  task mod => mod.source_file
  module_svg_path = mod.slug.sub_ext('.svg')

  faceplate_build_file = svg_build_dir / module_svg_path
  file faceplate_build_file => [svg_build_dir, mod] do
    SvgFile.new(path: faceplate_build_file, content: mod.faceplate_shape).write
  end
  task build: faceplate_build_file

  # faceplate_install_file = svg_install_dir / module_svg_path
  # file faceplate_install_file => [svg_install_dir, faceplate_build_file] do
  #   inkscape(from: faceplate_build_file, to: faceplate_install_file)
  # end
  # task install: faceplate_install_file

  image_build_file = image_build_dir / module_svg_path
  file image_build_file => [image_build_dir, mod] do
    SvgFile.new(path: image_build_file, content: mod.image_shape).write
  end
  task build: image_build_file

  # image_install_file = image_install_dir / module_svg_path
  # file image_install_file => [image_install_dir, image_build_file] do
  #   inkscape(from: image_build_file, to: image_install_file)
  # end
  # task install: image_install_file
end

controls_by_file_path = {}

modules.each do |mod|
  mod.control_shapes.map do |control|
    path = Pathname(mod.slug) / control.slug
    controls_by_file_path[path] = control
    task control => mod
  end
end

controls_by_file_path.each do |path, control|
  control_build_file = svg_build_dir / path
  directory control_build_file.parent
  file control_build_file => [control_build_file.parent, control] do
    SvgFile.new(path: control_build_file, content: control).write
  end
  task build: control_build_file
end

desc 'Build SVG files'
task :build

desc 'Install SVG files'
task :install

desc 'Remove and rebuild SVG files'
task fresh: [:clean, :default]

desc 'Remove, rebuild, and reinstall SVG files'
task reinstall: [:clobber, :install]

task default: [:build]

CLEAN.include image_build_dir, svg_build_dir
CLOBBER.include image_install_dir, svg_install_dir
